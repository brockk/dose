<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparing dose-escalation designs by simulation • escalation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Comparing dose-escalation designs by simulation">
<meta property="og:description" content="escalation">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">escalation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/A100-DoseSelectors.html">Using escalation</a>
    </li>
    <li>
      <a href="../articles/A205-CRM.html">Continual Reassessment Method</a>
    </li>
    <li>
      <a href="../articles/A207-NBG.html">Neuenschwander, Branson &amp; Gsponer</a>
    </li>
    <li>
      <a href="../articles/A210-TPI.html">Toxicity Probability Interval Design</a>
    </li>
    <li>
      <a href="../articles/A220-mTPI.html">Modified Toxicity Probability Interval Design</a>
    </li>
    <li>
      <a href="../articles/A230-BOIN.html">Bayesian Optimal Interval Design</a>
    </li>
    <li>
      <a href="../articles/A600-DosePaths.html">Working with dose-paths</a>
    </li>
    <li>
      <a href="../articles/A700-Simulation.html">Simulating dose-escalation trials</a>
    </li>
    <li>
      <a href="../articles/A710-SimulationComparison.html">Comparing dose-escalation designs by simulation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Comparing dose-escalation designs by
simulation</h1>
            
      
      
      <div class="hidden name"><code>A710-SimulationComparison.Rmd</code></div>

    </div>

    
    
<p>The <code>escalation</code> package by Kristian Brock. Documentation
is hosted at <a href="https://brockk.github.io/escalation/" class="external-link uri">https://brockk.github.io/escalation/</a></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette focuses on the common task of comparing competing
dose-escalation designs by simulation. Before reading on, be sure you
have read the <a href="https://brockk.github.io/escalation/" class="external-link">README
file</a> for a general explanation of how to compose dose-finding
designs in <code>escalation</code>; and the <a href="A700-Simulation.html">Simulation vignette</a> for a general
introduction to using simulation.</p>
</div>
<div class="section level2">
<h2 id="comparing-competing-designs">Comparing competing designs<a class="anchor" aria-label="anchor" href="#comparing-competing-designs"></a>
</h2>
<p>In <code>simulate_compare</code>, we implement the method of <span class="citation">Sweeting et al. (2023)</span> to efficiently compare
dose-finding designs. The crux of this method is to ensure that the same
simulated patients are used for each competing design so that, for
instance, if a patient is given dose 2 by one design and experiences
toxicity, then that patient will also experience toxicity if given dose
2 or above by any other design. Ensuring consistency across simulated
iterates in this way reduces Monte Carlo error and allows much faster
identification of differences between designs.</p>
<p>For example, let us compare the behaviour of the 3+3 and CRM designs
investigated above. We start by defining the competing designs in a list
with convenient names:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">escalation</span><span class="op">)</span></span>
<span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">skeleton</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">designs</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"3+3"</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_three_plus_three.html">get_three_plus_three</a></span><span class="op">(</span>num_doses <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="st">"CRM"</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    <span class="st">"Stopping CRM"</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/stop_when_too_toxic.html">stop_when_too_toxic</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="fl">1</span>, tox_threshold <span class="op">=</span> <span class="fl">0.35</span>, confidence <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Here we will compare three designs: 3+3; CRM without a toxicity
stopping rule; and an otherwise identical CRM design with a toxicity
stopping rule. The names we provide will be reused.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_sims</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">true_prob_tox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.12</span>, <span class="fl">0.27</span>, <span class="fl">0.44</span>, <span class="fl">0.53</span>, <span class="fl">0.57</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_compare.html">simulate_compare</a></span><span class="op">(</span></span>
<span>  <span class="va">designs</span>, </span>
<span>  num_sims <span class="op">=</span> <span class="va">num_sims</span>, </span>
<span>  true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running 3+3 </span></span>
<span><span class="co">#&gt; Running CRM </span></span>
<span><span class="co">#&gt; Running Stopping CRM</span></span></code></pre></div>
<p>We provide a convenient function to quickly visualise how the
probability of selecting each dose in each design evolved as the
simulations progressed:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/convergence_plot.html">convergence_plot</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span></code></pre></div>
<p><img src="A710-SimulationComparison_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>We can see immediately, for instance, that the designs generally
agree that dose 2 is the best MTD candidate, and that the CRM designs
are much more likely to recommend dose 3. We can be more precise by
formally contrasting the probability of selecting each dose for each
pair of designs:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">5</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">delta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_linerange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">delta_l</span>, ymax <span class="op">=</span> <span class="va">delta_u</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">comparison</span> <span class="op">~</span> <span class="va">dose</span>,</span>
<span>             labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span></span>
<span>               .rows <span class="op">=</span> <span class="va">label_both</span>,</span>
<span>               .cols <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="A710-SimulationComparison_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>The error bars here reflect 95% symmetric asymptotic normal
confidence intervals. Change the <code>alpha = 0.05</code> parameter
when calling <code>as_tibble(sims)</code> to get confident intervals for
a different significance level. We see that, even with the very small
sample size of 50 simulated trials, the CRM designs are significantly
more likely to recommend dose 3 than the 3+3 design. In contrast, in
this scenario there is very little difference at all between the two CRM
variants.</p>
</div>
<div class="section level2">
<h2 id="working-with-patientsamples">Working with PatientSamples<a class="anchor" aria-label="anchor" href="#working-with-patientsamples"></a>
</h2>
<p>The idea at the core of the method by <span class="citation">Sweeting
et al. (2023)</span> for efficient comparison of competing designs is to
use the same patients across different designs. This reduces Monte Carlo
error by examining where the designs differ in their recommendations
given identical inputs.</p>
<p>This is achieved in <code>escalation</code> using classes inheriting
from <code>PatientSample</code>. A single <code>PatientSample</code>
reflects one particular state of the world, where patient <span class="math inline">\(i\)</span> would reliably experience a toxicity or
efficacy event if treated at a particular dose. The consistent
occurrence of events is managed using latent uniform random variables.
We show how to import and export these variables, and use them to infer
potential outcomes at a range of doses.</p>
<p>To illustrate some of the fine-grained features of working with
patient samples, we reproduce the BOIN12 example in <span class="citation">Sweeting et al. (2023)</span>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_doses</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span>  <span class="st">"BOIN12 v1"</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_boin12.html">get_boin12</a></span><span class="op">(</span>num_doses <span class="op">=</span> <span class="va">num_doses</span>,</span>
<span>                          phi_t <span class="op">=</span> <span class="fl">0.35</span>, phi_e <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                          u2 <span class="op">=</span> <span class="fl">40</span>, u3 <span class="op">=</span> <span class="fl">60</span>,</span>
<span>                          c_t <span class="op">=</span> <span class="fl">0.95</span>, c_e <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stop_when_n_at_dose.html">stop_when_n_at_dose</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span>,  dose <span class="op">=</span> <span class="st">'any'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">36</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="st">"BOIN12 v2"</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_boin12.html">get_boin12</a></span><span class="op">(</span>num_doses <span class="op">=</span> <span class="va">num_doses</span>,</span>
<span>                          phi_t <span class="op">=</span> <span class="fl">0.35</span>, phi_e <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                          u2 <span class="op">=</span> <span class="fl">40</span>, u3 <span class="op">=</span> <span class="fl">60</span>,</span>
<span>                          c_t <span class="op">=</span> <span class="fl">0.85</span>, c_e <span class="op">=</span> <span class="fl">0.8</span></span>
<span>                          <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stop_when_n_at_dose.html">stop_when_n_at_dose</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span>,  dose <span class="op">=</span> <span class="st">'any'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">36</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="exporting-the-underlying-latent-variables">Exporting the underlying latent variables<a class="anchor" aria-label="anchor" href="#exporting-the-underlying-latent-variables"></a>
</h3>
<p>By setting <code>return_patient_samples = TRUE</code> in the call to
<code>simulate_compare</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">true_prob_tox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.18</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="va">true_prob_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.40</span>, <span class="fl">0.50</span>, <span class="fl">0.52</span>, <span class="fl">0.53</span>, <span class="fl">0.53</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_compare.html">simulate_compare</a></span><span class="op">(</span></span>
<span>  designs <span class="op">=</span> <span class="va">designs</span>, </span>
<span>  num_sims <span class="op">=</span> <span class="fl">50</span>, </span>
<span>  true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>, </span>
<span>  true_prob_eff <span class="op">=</span> <span class="va">true_prob_eff</span>, </span>
<span>  return_patient_samples <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running BOIN12 v1 </span></span>
<span><span class="co">#&gt; Running BOIN12 v2</span></span></code></pre></div>
<p>we ensure the generated patient samples are exported in the returned
object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"patient_samples"</span><span class="op">)</span></span></code></pre></div>
<p>There are 50 patient-samples because we performed 50 simulated
iterates:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50</span></span></code></pre></div>
<p>Each iterate is associated with one patient-sample.</p>
<p>For instance, the uniformly-distributed random variables that
determine the occurrence of toxicity events in the first simulated
iterate are:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">tox_u</span></span>
<span><span class="co">#&gt;  [1] 0.69817312 0.70142031 0.30320913 0.44945646 0.11031108 0.13106918</span></span>
<span><span class="co">#&gt;  [7] 0.29230717 0.81558326 0.02112692 0.96611989 0.64736749 0.91045726</span></span>
<span><span class="co">#&gt; [13] 0.65435328 0.06133627 0.45295471 0.19192290 0.27820403 0.42659125</span></span>
<span><span class="co">#&gt; [19] 0.88575333 0.30889712 0.65158215 0.03589462 0.22038706 0.24535641</span></span>
<span><span class="co">#&gt; [25] 0.11568014 0.55189023 0.62894470</span></span></code></pre></div>
<p>and the equivalent for efficacy events are:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">eff_u</span></span>
<span><span class="co">#&gt;  [1] 0.4570092149 0.4157109936 0.8765880703 0.8422317195 0.8632152062</span></span>
<span><span class="co">#&gt;  [6] 0.2954267922 0.6152471751 0.0005296487 0.4411276847 0.0221378489</span></span>
<span><span class="co">#&gt; [11] 0.8728519802 0.6238860050 0.6504830588 0.7410900716 0.4894901910</span></span>
<span><span class="co">#&gt; [16] 0.4564330971 0.0749628954 0.3724637846 0.7188321317 0.2872392512</span></span>
<span><span class="co">#&gt; [21] 0.1984391382 0.6658069612 0.1914782405 0.4981285664 0.8587655805</span></span>
<span><span class="co">#&gt; [26] 0.9091297414 0.0394975643</span></span></code></pre></div>
<p>These values reflect the patient-specific propensities to toxicity
and efficacy. For instance, we see that the first patient would always
experience a toxicity if treated at a dose with associated true toxicity
probability less than 0.6981731. Likewise, the same patient would
experience efficacy if treated at a dose with associated true efficacy
probability less than 0.4570092.</p>
<p>These latent variables can be exported using R’s many I/O functions
and formats.</p>
</div>
<div class="section level3">
<h3 id="calculating-potential-outcomes">Calculating potential outcomes<a class="anchor" aria-label="anchor" href="#calculating-potential-outcomes"></a>
</h3>
<p>We can calculate all potential outcomes for a list of patient-samples
by calling <code>get_potential_outcomes</code> and providing the true
event probabilities:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_potential_outcomes.html">get_potential_outcomes</a></span><span class="op">(</span></span>
<span>  patient_samples <span class="op">=</span> <span class="va">ps</span>,</span>
<span>  true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>  true_prob_eff <span class="op">=</span> <span class="va">true_prob_eff</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that were we working with tox-only dose-escalation designs like
CRM or mTPI (for example), we would omit the <code>true_prob_eff</code>
parameter.</p>
<p>For instance, the potential outcomes in the first simulated iterate
are:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; $tox</span></span>
<span><span class="co">#&gt;       [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt;  [1,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [2,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [3,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt;  [4,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt;  [5,]    0    0    1    1    1</span></span>
<span><span class="co">#&gt;  [6,]    0    0    1    1    1</span></span>
<span><span class="co">#&gt;  [7,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt;  [8,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [9,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [10,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [11,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [12,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [13,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [14,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt; [15,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [16,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [17,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [18,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [19,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [20,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [21,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [22,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [23,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [24,]    0    0    0    0    1</span></span>
<span><span class="co">#&gt; [25,]    0    0    1    1    1</span></span>
<span><span class="co">#&gt; [26,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [27,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $eff</span></span>
<span><span class="co">#&gt;       [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt;  [1,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt;  [2,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt;  [3,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [4,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [5,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [6,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt;  [7,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt;  [8,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt;  [9,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt; [10,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [11,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [12,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [13,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [14,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [15,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt; [16,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt; [17,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [18,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [19,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [20,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [21,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [22,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [23,]    1    1    1    1    1</span></span>
<span><span class="co">#&gt; [24,]    0    1    1    1    1</span></span>
<span><span class="co">#&gt; [25,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [26,]    0    0    0    0    0</span></span>
<span><span class="co">#&gt; [27,]    1    1    1    1    1</span></span></code></pre></div>
<p>We see that patient 1 would not have experienced a toxicity at any
dose because their underlying toxicity propensity variable was quite
high at 0.6981731. Gladly, however, the same patient would have
experienced efficacy at any dose at or above dose-level 2.</p>
</div>
<div class="section level3">
<h3 id="importing-the-underlying-latent-variables">Importing the underlying latent variables<a class="anchor" aria-label="anchor" href="#importing-the-underlying-latent-variables"></a>
</h3>
<p>We show above how to export the latent event variables to store of
use them elsewhere. We can also import the latent variables, to mimic
the patient population used in some external simulation, for
instance.</p>
<p>To do so, we instantiate a list of PatientSample objects, with one
for each simulated iterate. We will work with ten iterates in the
interests of speed:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_sims</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">num_sims</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va"><a href="../reference/PatientSample.html">PatientSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then call the <code>set_eff_and_tox</code> function on each to set
the latent toxicity and efficacy propensities to the desired values. For
illustration, let us simply sample uniform random variables and use
those. In a more realistic example, we would set the latent variables to
the values we wished to import, i.e. those values that were used in some
external study or idealised values that we wish to use.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">num_sims</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tox_u_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="va">eff_u_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="va">ps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">set_eff_and_tox</span><span class="op">(</span>tox_u <span class="op">=</span> <span class="va">tox_u_new</span>, eff_u <span class="op">=</span> <span class="va">eff_u_new</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We have set the latent variable vectors to have length 50. This means
we can work with up to 50 patients in each iterate. If the simulation
tries to use a 51st patient, we will receive an error. When setting the
latent variables in this way, ensure you use enough values to cover your
maximum sample size.</p>
<p>To use the patient-samples we have created in simulated trials, we
specify the <code>patient_samples</code> parameter:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_compare.html">simulate_compare</a></span><span class="op">(</span></span>
<span>  designs <span class="op">=</span> <span class="va">designs</span>, </span>
<span>  num_sims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>, </span>
<span>  true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>, </span>
<span>  true_prob_eff <span class="op">=</span> <span class="va">true_prob_eff</span>, </span>
<span>  patient_samples <span class="op">=</span> <span class="va">ps</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running BOIN12 v1 </span></span>
<span><span class="co">#&gt; Running BOIN12 v2</span></span></code></pre></div>
<p>Having specified the exact patient population in this way, if we run
the simulation study a second time with the same patients:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_compare.html">simulate_compare</a></span><span class="op">(</span></span>
<span>  designs <span class="op">=</span> <span class="va">designs</span>, </span>
<span>  num_sims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>, </span>
<span>  true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>, </span>
<span>  true_prob_eff <span class="op">=</span> <span class="va">true_prob_eff</span>, </span>
<span>  patient_samples <span class="op">=</span> <span class="va">ps</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running BOIN12 v1 </span></span>
<span><span class="co">#&gt; Running BOIN12 v2</span></span></code></pre></div>
<p>we will see that the decisions within design are (usually) identical
within a design. E.g.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/recommended_dose.html">recommended_dose</a></span><span class="op">(</span><span class="va">x1</span><span class="op">[[</span><span class="st">"BOIN12 v1"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> </span>
<span>    <span class="fu"><a href="../reference/recommended_dose.html">recommended_dose</a></span><span class="op">(</span><span class="va">x2</span><span class="op">[[</span><span class="st">"BOIN12 v1"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>The first BOIN12 variant recommends the exact same dose in the two
batches because the patients are the same.</p>
<p>For completeness, when might the decisions vary despite the same
patients being used? In a design that has inherent randomness. E.g.
Wages &amp; Tait’s design features adaptive randomisation, meaning that,
even with identical patients, different behaviours will be seen.</p>
</div>
<div class="section level3">
<h3 id="correlated-toxicity-and-efficacy-outcomes">Correlated toxicity and efficacy outcomes<a class="anchor" aria-label="anchor" href="#correlated-toxicity-and-efficacy-outcomes"></a>
</h3>
<p>Finally, let us introduce the <code>CorrelatedPatientSample</code> to
sample correlated toxicity and efficacy events. To coerce a correlation
of 0.5 <em>between the latent uniform tox and eff event
propensities</em>, we run:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CorrelatedPatientSample.html">CorrelatedPatientSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>num_patients <span class="op">=</span> <span class="fl">100</span>, rho <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p>We can observe</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">ps</span><span class="op">$</span><span class="va">tox_u</span>, <span class="va">ps</span><span class="op">$</span><span class="va">eff_u</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4827035</span></span></code></pre></div>
<p>that the correlation is close to desired. Note however, that the
correlation of the binary level events is not, in general, equal to the
target value of rho, because they depend on the event probabilities:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">ps</span><span class="op">$</span><span class="fu">get_patient_tox</span><span class="op">(</span><span class="va">i</span>, prob_tox <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">ps</span><span class="op">$</span><span class="fu">get_patient_eff</span><span class="op">(</span><span class="va">i</span>, prob_eff <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">tox</span>, <span class="va">eff</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3027588</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="further-refinements">Further refinements<a class="anchor" aria-label="anchor" href="#further-refinements"></a>
</h2>
<p>Check out the <em>Further refinements</em> section of the <a href="A700-Simulation.html">Simulation vignette</a> for further ways of
refining the behaviour of simulations, including changing the cohort
size and timing of patient arrivals, simulating the conclusion of
partly-observed trials, tweaking the immediate next dose, returning all
interim model fits, and working with large trials. The methods described
there apply to both <code>simulate_trials</code> and
<code>simulate_compare</code>.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-sweeting2023" class="csl-entry">
Sweeting, Michael, Daniel Slade, Daniel Jackson, and Kristian Brock.
2023. <span>“Potential Outcome Simulation for Efficient Head-to-Head
Comparison of Adaptive Dose-Finding Designs.”</span> <em>Preprint</em>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kristian Brock, Daniel Slade, Michael Sweeting.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
